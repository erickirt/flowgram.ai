import { SourceCode } from '@theme';
import { BasicStory } from 'components/form-materials/components/batch-outputs';

# BatchOutputs

`BatchOutputs` æ˜¯ä¸€ä¸ªç”¨äºé…ç½®å¾ªç¯è¾“å‡ºçš„é”®å€¼å¯¹ç¼–è¾‘å™¨ç»„ä»¶ã€‚åœ¨å¾ªç¯èŠ‚ç‚¹åœºæ™¯ä¸­ï¼Œå®ƒå…è®¸ç”¨æˆ·å®šä¹‰æ¯æ¬¡è¿­ä»£éœ€è¦æ”¶é›†çš„è¾“å‡ºå€¼ï¼Œè¿™äº›å€¼æœ€ç»ˆä¼šè¢«èšåˆæˆæ•°ç»„ã€‚

**æ ¸å¿ƒç‰¹æ€§ï¼š**

- â• **åŠ¨æ€æ·»åŠ /åˆ é™¤**ï¼šç”¨æˆ·å¯ä»¥è‡ªç”±æ·»åŠ æˆ–åˆ é™¤è¾“å‡ºé”®å€¼å¯¹
- âœï¸ **é”®åç¼–è¾‘**ï¼šä¸ºæ¯ä¸ªè¾“å‡ºå®šä¹‰ä¸€ä¸ªå”¯ä¸€çš„é”®å
- ğŸ”— **å˜é‡å¼•ç”¨**ï¼šé€šè¿‡å˜é‡é€‰æ‹©å™¨å¼•ç”¨å¾ªç¯ä½“å†…å¯ç”¨çš„å˜é‡
- ğŸ‘ï¸ **åªè¯»æ¨¡å¼**ï¼šæ”¯æŒåªè¯»å±•ç¤ºï¼Œé€‚ç”¨äºæŸ¥çœ‹åœºæ™¯

:::warning

`BatchOutputs` å¿…é¡»æ­é… [batchOutputsPlugin](../form-plugins/batch-outputs-plugin) ä½¿ç”¨æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚è¿™æ˜¯å› ä¸ºï¼š
1. ç»„ä»¶è´Ÿè´£ UI äº¤äº’ï¼Œæ”¶é›†ç”¨æˆ·é…ç½®çš„è¾“å‡ºé”®å€¼å¯¹
2. æ’ä»¶è´Ÿè´£å°†é…ç½®è½¬æ¢ä¸ºå˜é‡å£°æ˜ï¼Œå¹¶è°ƒæ•´ä½œç”¨åŸŸé“¾

:::

:::info{title="å®Œæ•´æ–¹æ¡ˆæ¦‚è§ˆ"}

å®ç°ä¸€ä¸ªå®Œæ•´çš„å¾ªç¯èŠ‚ç‚¹éœ€è¦ä»¥ä¸‹ä¸‰ä¸ªç‰©æ–™é…åˆä½¿ç”¨ï¼š

| ç‰©æ–™ | ç±»å‹ | èŒè´£ |
|------|------|------|
| [BatchVariableSelector](./batch-variable-selector) | ç»„ä»¶ | é€‰æ‹©å¾ªç¯çš„æ•°ç»„æ•°æ®æº |
| [provideBatchInputEffect](../effects/provide-batch-input) | å‰¯ä½œç”¨ | ç”Ÿæˆ `item` å’Œ `index` å±€éƒ¨å˜é‡ |
| **BatchOutputs** + [batchOutputsPlugin](../form-plugins/batch-outputs-plugin) | ç»„ä»¶ + æ’ä»¶ | é…ç½®å¾ªç¯è¾“å‡ºå¹¶ç”Ÿæˆæ•°ç»„ç±»å‹å˜é‡ |

:::

## æ¡ˆä¾‹æ¼”ç¤º

### åŸºæœ¬ä½¿ç”¨

<BasicStory />

```tsx pure title="form-meta.tsx"
import { FormRenderProps, FlowNodeJSON, Field, FormMeta } from '@flowgram.ai/free-layout-editor';
import {
  BatchOutputs,
  BatchVariableSelector,
  createBatchOutputsFormPlugin,
  IFlowRefValue,
  provideBatchInputEffect,
} from '@flowgram.ai/form-materials';

interface LoopNodeJSON extends FlowNodeJSON {
  data: {
    loopFor: IFlowRefValue;
  };
}

export const LoopFormRender = ({ form }: FormRenderProps<LoopNodeJSON>) => {
  return (
    <>
      <FormHeader />
      <FormContent>
        <Field<IFlowRefValue> name="loopFor">
          {({ field, fieldState }) => (
            <FormItem name="loopFor" type="array" required>
              <BatchVariableSelector
                style={{ width: '100%' }}
                value={field.value?.content}
                onChange={(val) => field.onChange({ type: 'ref', content: val })}
                hasError={Object.keys(fieldState?.errors || {}).length > 0}
              />
            </FormItem>
          )}
        </Field>
        <Field<Record<string, IFlowRefValue | undefined> | undefined> name="loopOutputs">
          {({ field, fieldState }) => (
            <FormItem name="loopOutputs" type="object" vertical>
              <BatchOutputs
                style={{ width: '100%' }}
                value={field.value}
                onChange={(val) => field.onChange(val)}
                hasError={Object.keys(fieldState?.errors || {}).length > 0}
              />
            </FormItem>
          )}
        </Field>
      </FormContent>
    </>
  );
};

export const formMeta: FormMeta = {
  render: LoopFormRender,
  effect: {
    loopFor: provideBatchInputEffect,
  },
  plugins: [createBatchOutputsFormPlugin({ outputKey: 'loopOutputs', inferTargetKey: 'outputs' })],
};
```

:::info{title="å…³äº FormHeaderã€FormContentã€FormItem"}

ä¸Šè¿°ä»£ç ä¸­çš„ `FormHeader`ã€`FormContent`ã€`FormItem` æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„å¸ƒå±€ç»„ä»¶ï¼Œç”¨äºç»Ÿä¸€è¡¨å•æ ·å¼ã€‚ä½ å¯ä»¥æ ¹æ®é¡¹ç›®éœ€æ±‚è‡ªè¡Œå®ç°æˆ–æ›¿æ¢ä¸ºå…¶ä»– UI ç»„ä»¶ã€‚

:::

### åªè¯»æ¨¡å¼

é€šè¿‡è®¾ç½® `readonly` å±æ€§å¯ä»¥ç¦ç”¨ç¼–è¾‘åŠŸèƒ½ï¼Œé€‚ç”¨äºæŸ¥çœ‹æˆ–é¢„è§ˆåœºæ™¯ï¼š

```tsx pure
<BatchOutputs
  readonly
  value={{
    names: { type: 'ref', content: ['item', 'name'] },
    ages: { type: 'ref', content: ['item', 'age'] },
  }}
/>
```

## API å‚è€ƒ

### BatchOutputs Props

| å±æ€§å | ç±»å‹ | é»˜è®¤å€¼ | æè¿° |
|--------|------|--------|------|
| `value` | `Record<string, IFlowRefValue \| undefined>` | - | è¾“å‡ºé”®å€¼å¯¹å¯¹è±¡ï¼Œé”®ä¸ºè¾“å‡ºåç§°ï¼Œå€¼ä¸ºå˜é‡å¼•ç”¨ |
| `onChange` | `(value?: Record<string, IFlowRefValue \| undefined>) => void` | - | å€¼å˜åŒ–æ—¶çš„å›è°ƒå‡½æ•° |
| `readonly` | `boolean` | `false` | æ˜¯å¦ä¸ºåªè¯»æ¨¡å¼ |
| `hasError` | `boolean` | `false` | æ˜¯å¦æ˜¾ç¤ºé”™è¯¯çŠ¶æ€ |
| `style` | `React.CSSProperties` | - | è‡ªå®šä¹‰æ ·å¼ |

### å€¼ç±»å‹è¯´æ˜

```typescript
type ValueType = Record<string, IFlowRefValue | undefined>;

interface IFlowRefValue {
  type: 'ref';
  content?: string[];
}
```

#### å€¼ç»“æ„ç¤ºä¾‹

```typescript
{
  names: { type: 'ref', content: ['loop_1_locals', 'item', 'name'] },
  ages: { type: 'ref', content: ['loop_1_locals', 'item', 'age'] },
  scores: { type: 'ref', content: ['loop_1_locals', 'item', 'score'] },
}
```

## æºç å¯¼è¯»

<SourceCode
  href="https://github.com/bytedance/flowgram.ai/tree/main/packages/materials/form-materials/src/components/batch-outputs"
/>

ä½¿ç”¨ CLI å‘½ä»¤å¯ä»¥å¤åˆ¶æºä»£ç åˆ°æœ¬åœ°ï¼š

```bash
npx @flowgram.ai/cli@latest materials components/batch-outputs
```

### ç›®å½•ç»“æ„è®²è§£

```
batch-outputs/
â”œâ”€â”€ index.tsx          # ä¸»ç»„ä»¶å®ç°
â”œâ”€â”€ types.ts           # ç±»å‹å®šä¹‰
â””â”€â”€ styles.css         # æ ·å¼æ–‡ä»¶
```

### æ ¸å¿ƒå®ç°è¯´æ˜

#### ç»„ä»¶ç»“æ„

BatchOutputs ç»„ä»¶åŸºäº `useObjectList` hook å®ç°åŠ¨æ€åˆ—è¡¨ç®¡ç†ï¼Œæ¯ä¸€è¡ŒåŒ…å«ï¼š
- **Input**ï¼šç”¨äºç¼–è¾‘è¾“å‡ºé”®å
- **InjectVariableSelector**ï¼šç”¨äºé€‰æ‹©å˜é‡å¼•ç”¨
- **Delete Button**ï¼šåˆ é™¤å½“å‰è¡Œ

#### æ•°æ®æµå‘

```mermaid
graph TD
    A[BatchOutputs ç»„ä»¶] --> B[useObjectList Hook]
    B --> C[list çŠ¶æ€]
    B --> D[add æ–¹æ³•]
    B --> E[updateKey æ–¹æ³•]
    B --> F[updateValue æ–¹æ³•]
    B --> G[remove æ–¹æ³•]

    C --> H[æ¸²æŸ“åˆ—è¡¨]
    H --> I[Input é”®åç¼–è¾‘]
    H --> J[VariableSelector å˜é‡é€‰æ‹©]
    H --> K[Delete åˆ é™¤æŒ‰é’®]

    D --> L[æ·»åŠ æŒ‰é’®]

    I --> E
    J --> F
    K --> G
    
    E --> M[onChange å›è°ƒ]
    F --> M
    G --> M
    M --> N[æ›´æ–°å¤–éƒ¨ value]
```

#### useObjectList Hook

`useObjectList` æ˜¯ä¸€ä¸ªé€šç”¨çš„åŠ¨æ€å¯¹è±¡åˆ—è¡¨ç®¡ç† hookï¼Œæ ¸å¿ƒåŠŸèƒ½ï¼š

1. **åˆ—è¡¨çŠ¶æ€ç®¡ç†**ï¼šç»´æŠ¤å¸¦æœ‰å”¯ä¸€ ID çš„åˆ—è¡¨é¡¹
2. **åŒå‘åŒæ­¥**ï¼šåœ¨ `value` å±æ€§å˜åŒ–æ—¶åŒæ­¥æ›´æ–°åˆ—è¡¨
3. **å¢åˆ æ”¹æ“ä½œ**ï¼šæä¾› `add`ã€`remove`ã€`updateKey`ã€`updateValue` æ–¹æ³•

```typescript
interface UseObjectListOptions<T> {
  value?: Record<string, T | undefined>;
  onChange?: (value?: Record<string, T | undefined>) => void;
}

interface UseObjectListReturn<T> {
  list: Array<{ id: string; key: string; value: T | undefined }>;
  add: () => void;
  remove: (id: string) => void;
  updateKey: (id: string, newKey: string) => void;
  updateValue: (id: string, newValue: T) => void;
}

const { list, add, updateKey, updateValue, remove } = useObjectList({
  value,
  onChange,
});
```

#### å®Œæ•´æ•°æ®æµæ—¶åºå›¾

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant UI as BatchOutputs ç»„ä»¶
    participant Hook as useObjectList
    participant Form as è¡¨å•ç³»ç»Ÿ
    participant Plugin as batchOutputsPlugin

    User->>UI: ç‚¹å‡»æ·»åŠ æŒ‰é’®
    UI->>Hook: è°ƒç”¨ add()
    Hook->>Hook: ç”Ÿæˆæ–°çš„åˆ—è¡¨é¡¹ï¼ˆå¸¦å”¯ä¸€ IDï¼‰
    Hook->>Form: è§¦å‘ onChange
    Form->>Plugin: è¡¨å•å€¼å˜åŒ–
    Plugin->>Plugin: ç”Ÿæˆå˜é‡å£°æ˜

    User->>UI: ç¼–è¾‘é”®å
    UI->>Hook: è°ƒç”¨ updateKey(id, newKey)
    Hook->>Form: è§¦å‘ onChange
    Form->>Plugin: è¡¨å•å€¼å˜åŒ–
    Plugin->>Plugin: æ›´æ–°å˜é‡å£°æ˜

    User->>UI: é€‰æ‹©å˜é‡
    UI->>Hook: è°ƒç”¨ updateValue(id, refValue)
    Hook->>Form: è§¦å‘ onChange
    Form->>Plugin: è¡¨å•å€¼å˜åŒ–
    Plugin->>Plugin: æ›´æ–°å˜é‡å£°æ˜
```

### ä¾èµ–æ¢³ç†

#### flowgram API

[**@flowgram.ai/editor**](https://github.com/bytedance/flowgram.ai/tree/main/packages/client/editor)
- [`I18n`](https://flowgram.ai/auto-docs/editor/modules/I18n): å›½é™…åŒ–å·¥å…·ï¼Œç”¨äºæŒ‰é’®æ–‡æ¡ˆ

#### ä¾èµ–çš„å…¶ä»–ç‰©æ–™

[**useObjectList**](https://github.com/bytedance/flowgram.ai/tree/main/packages/materials/form-materials/src/hooks/use-object-list)
- åŠ¨æ€å¯¹è±¡åˆ—è¡¨ç®¡ç† hookï¼Œå¤„ç†åˆ—è¡¨çš„å¢åˆ æ”¹æ“ä½œ

[**InjectVariableSelector**](./variable-selector)
- æ³¨å…¥å¼å˜é‡é€‰æ‹©å™¨ï¼Œç”¨äºé€‰æ‹©å˜é‡å¼•ç”¨

#### ç¬¬ä¸‰æ–¹ä¾èµ–

- `@douyinfe/semi-ui`: UI ç»„ä»¶åº“ï¼Œä½¿ç”¨ Buttonã€Input ç»„ä»¶
- `@douyinfe/semi-icons`: å›¾æ ‡åº“ï¼Œä½¿ç”¨ IconDeleteã€IconPlus å›¾æ ‡

## å¸¸è§é—®é¢˜

### ä¸ºä»€ä¹ˆéœ€è¦åŒæ—¶ä½¿ç”¨ BatchOutputs ç»„ä»¶å’Œ batchOutputsPluginï¼Ÿ

è¿™æ˜¯å…³æ³¨ç‚¹åˆ†ç¦»çš„è®¾è®¡ï¼š

| è§’è‰² | èŒè´£ |
|------|------|
| `BatchOutputs` ç»„ä»¶ | æä¾› UI äº¤äº’ï¼Œè®©ç”¨æˆ·é…ç½®è¾“å‡ºé”®åå’Œå˜é‡å¼•ç”¨ |
| `batchOutputsPlugin` | å¤„ç†æ•°æ®é€»è¾‘ï¼Œå°†é…ç½®è½¬æ¢ä¸ºå˜é‡å£°æ˜å¹¶è°ƒæ•´ä½œç”¨åŸŸé“¾ |

å•ç‹¬ä½¿ç”¨ç»„ä»¶åªèƒ½æ”¶é›†æ•°æ®ï¼Œæ— æ³•ç”Ÿæˆæœ‰æ•ˆçš„è¾“å‡ºå˜é‡ï¼›å•ç‹¬ä½¿ç”¨æ’ä»¶åˆ™æ²¡æœ‰ UI æ¥é…ç½®æ•°æ®ã€‚

### BatchOutputs ä¸ InputsValues çš„åŒºåˆ«ï¼Ÿ

| ç‰¹æ€§ | BatchOutputs | InputsValues |
|------|--------------|--------------|
| ç”¨é€” | å¾ªç¯è¾“å‡ºé…ç½® | èŠ‚ç‚¹è¾“å…¥é…ç½® |
| å€¼ç±»å‹ | `Record<string, IFlowRefValue>` | `IInputsValues` |
| å˜é‡å¼•ç”¨ | åªæ”¯æŒå˜é‡å¼•ç”¨ | æ”¯æŒå¸¸é‡å’Œå˜é‡å¼•ç”¨ |
| é€‚ç”¨åœºæ™¯ | Loop èŠ‚ç‚¹çš„è¾“å‡ºèšåˆ | é€šç”¨èŠ‚ç‚¹çš„è¾“å…¥å‚æ•° |

### å¦‚ä½•è‡ªå®šä¹‰å˜é‡é€‰æ‹©å™¨çš„è¿‡æ»¤æ¡ä»¶ï¼Ÿ

ç›®å‰ `BatchOutputs` å†…éƒ¨ä½¿ç”¨ `InjectVariableSelector`ï¼Œä¸æ”¯æŒè‡ªå®šä¹‰è¿‡æ»¤æ¡ä»¶ã€‚å¦‚æœéœ€è¦è‡ªå®šä¹‰ï¼Œå¯ä»¥å‚è€ƒæºç å®ç°è‡ªå·±çš„ç»„ä»¶ï¼š

```tsx
import { useObjectList } from '@flowgram.ai/form-materials';
import { VariableSelector } from '@flowgram.ai/form-materials';

function CustomBatchOutputs(props) {
  const { list, add, updateKey, updateValue, remove } = useObjectList(props);
  
  return (
    <div>
      {list.map((item) => (
        <div key={item.id}>
          <Input value={item.key} onChange={(v) => updateKey(item.id, v)} />
          <VariableSelector
            value={item.value?.content}
            onChange={(v) => updateValue(item.id, { type: 'ref', content: v })}
            includeSchema={{ type: 'string' }}
          />
          <Button onClick={() => remove(item.id)}>åˆ é™¤</Button>
        </div>
      ))}
      <Button onClick={() => add()}>æ·»åŠ </Button>
    </div>
  );
}
```

### å¦‚ä½•è·å–ç”Ÿæˆçš„è¾“å‡ºå˜é‡ç±»å‹ï¼Ÿ

é…åˆ `batchOutputsPlugin` ä½¿ç”¨æ—¶ï¼Œå¦‚æœé…ç½®äº† `inferTargetKey`ï¼Œè¾“å‡ºå˜é‡çš„ JSON Schema ä¼šåœ¨è¡¨å•æäº¤æ—¶è‡ªåŠ¨å†™å…¥æŒ‡å®šå­—æ®µï¼š

```typescript
plugins: [
  createBatchOutputsFormPlugin({ 
    outputKey: 'loopOutputs', 
    inferTargetKey: 'outputs'
  })
]
```

æäº¤åçš„è¡¨å•æ•°æ®ç»“æ„ç¤ºä¾‹ï¼š

```typescript
{
  loopOutputs: {
    names: { type: 'ref', content: ['item', 'name'] },
    ages: { type: 'ref', content: ['item', 'age'] },
  },
  outputs: {
    type: 'object',
    properties: {
      names: { type: 'array', items: { type: 'string' } },
      ages: { type: 'array', items: { type: 'number' } },
    }
  }
}
```

### å¦‚ä½•å¤„ç†é”®åé‡å¤çš„æƒ…å†µï¼Ÿ

ç›®å‰ç»„ä»¶ä¸ä¼šè‡ªåŠ¨æ£€æµ‹é”®åé‡å¤ã€‚å»ºè®®åœ¨è¡¨å•å±‚é¢æ·»åŠ æ ¡éªŒé€»è¾‘ï¼š

```typescript
const formMeta: FormMeta = {
  validate: {
    loopOutputs: (value) => {
      if (!value) return;
      const keys = Object.keys(value);
      const uniqueKeys = new Set(keys);
      if (keys.length !== uniqueKeys.size) {
        return 'è¾“å‡ºé”®åä¸èƒ½é‡å¤';
      }
    },
  },
};
```

## ç›¸å…³ç‰©æ–™

- [BatchVariableSelector](./batch-variable-selector): æ•°ç»„å˜é‡é€‰æ‹©å™¨ï¼Œç”¨äºé€‰æ‹©å¾ªç¯è¾“å…¥
- [provideBatchInputEffect](../effects/provide-batch-input): å¾ªç¯è¾“å…¥å˜é‡è§£æå‰¯ä½œç”¨
- [batchOutputsPlugin](../form-plugins/batch-outputs-plugin): å¾ªç¯è¾“å‡ºæ’ä»¶ï¼Œå¤„ç†ä½œç”¨åŸŸé“¾å’Œç±»å‹æ¨å¯¼
