import { SourceCode } from '@theme';
import { BasicStory } from 'components/form-materials/effects/provide-batch-input';

# provideBatchInputEffect

`provideBatchInputEffect` æ˜¯ä¸€ä¸ªè¡¨å•å‰¯ä½œç”¨ï¼Œä¸“é—¨ç”¨äºå¾ªç¯èŠ‚ç‚¹åœºæ™¯ã€‚å®ƒèƒ½å¤Ÿå°†å¾ªç¯è¾“å…¥çš„æ•°ç»„å˜é‡è§£æä¸ºä¸¤ä¸ªå±€éƒ¨å˜é‡ï¼š

- **item**ï¼šå½“å‰è¿­ä»£çš„æ•°ç»„å…ƒç´ ï¼Œç±»å‹ä¼šæ ¹æ®è¾“å…¥æ•°ç»„çš„å…ƒç´ ç±»å‹è‡ªåŠ¨æ¨å¯¼
- **index**ï¼šå½“å‰è¿­ä»£çš„ç´¢å¼•ï¼Œç±»å‹ä¸º number

**æ ¸å¿ƒç‰¹æ€§ï¼š**

- ğŸ”„ **è‡ªåŠ¨ç±»å‹æ¨å¯¼**ï¼šä»æ•°ç»„ç±»å‹è‡ªåŠ¨æ¨å¯¼å‡º `item` çš„å…ƒç´ ç±»å‹
- ğŸ”’ **ç§æœ‰ä½œç”¨åŸŸ**ï¼šç”Ÿæˆçš„å˜é‡å­˜å‚¨åœ¨èŠ‚ç‚¹ç§æœ‰ä½œç”¨åŸŸï¼Œä»…å½“å‰èŠ‚ç‚¹åŠå­èŠ‚ç‚¹å¯è®¿é—®
- ğŸ¯ **å¾ªç¯ä¸“ç”¨**ï¼šä¸“ä¸ºæ‰¹å¤„ç†/å¾ªç¯åœºæ™¯è®¾è®¡

è¿™ä½¿å¾—å¾ªç¯ä½“å†…çš„å­èŠ‚ç‚¹å¯ä»¥å¼•ç”¨ `item` å’Œ `index` å˜é‡ï¼Œå®ç°å¯¹æ•°ç»„å…ƒç´ çš„é€ä¸ªå¤„ç†ã€‚

:::info{title="å®Œæ•´æ–¹æ¡ˆæ¦‚è§ˆ"}

å®ç°ä¸€ä¸ªå®Œæ•´çš„å¾ªç¯èŠ‚ç‚¹éœ€è¦ä»¥ä¸‹ä¸‰ä¸ªç‰©æ–™é…åˆä½¿ç”¨ï¼š

| ç‰©æ–™ | ç±»å‹ | èŒè´£ |
|------|------|------|
| [BatchVariableSelector](../components/batch-variable-selector) | ç»„ä»¶ | é€‰æ‹©å¾ªç¯çš„æ•°ç»„æ•°æ®æº |
| **provideBatchInputEffect** | å‰¯ä½œç”¨ | ç”Ÿæˆ `item` å’Œ `index` å±€éƒ¨å˜é‡ |
| [BatchOutputs](../components/batch-outputs) + [batchOutputsPlugin](../form-plugins/batch-outputs-plugin) | ç»„ä»¶ + æ’ä»¶ | é…ç½®å¾ªç¯è¾“å‡ºå¹¶ç”Ÿæˆæ•°ç»„ç±»å‹å˜é‡ |

:::

## æ¡ˆä¾‹æ¼”ç¤º

### åŸºæœ¬ä½¿ç”¨

:::tip

é€‰æ‹©ä¸€ä¸ªæ•°ç»„ç±»å‹çš„å˜é‡åï¼Œ`provideBatchInputEffect` ä¼šè‡ªåŠ¨ç”Ÿæˆ `item` å’Œ `index` å±€éƒ¨å˜é‡ï¼Œå¯ä»¥åœ¨ä¸‹æ–¹çš„å˜é‡é€‰æ‹©å™¨ä¸­çœ‹åˆ°è¿™äº›å˜é‡ã€‚

:::

<BasicStory />

```tsx pure title="form-meta.tsx"
import { FormRenderProps, FlowNodeJSON, Field, FormMeta } from '@flowgram.ai/free-layout-editor';
import {
  BatchOutputs,
  BatchVariableSelector,
  createBatchOutputsFormPlugin,
  IFlowRefValue,
  provideBatchInputEffect,
} from '@flowgram.ai/form-materials';

interface LoopNodeJSON extends FlowNodeJSON {
  data: {
    loopFor: IFlowRefValue;
  };
}

export const LoopFormRender = ({ form }: FormRenderProps<LoopNodeJSON>) => {
  return (
    <>
      <FormHeader />
      <FormContent>
        <Field<IFlowRefValue> name="loopFor">
          {({ field, fieldState }) => (
            <FormItem name="loopFor" type="array" required>
              <BatchVariableSelector
                style={{ width: '100%' }}
                value={field.value?.content}
                onChange={(val) => field.onChange({ type: 'ref', content: val })}
                hasError={Object.keys(fieldState?.errors || {}).length > 0}
              />
            </FormItem>
          )}
        </Field>
        <Field<Record<string, IFlowRefValue | undefined> | undefined> name="loopOutputs">
          {({ field, fieldState }) => (
            <FormItem name="loopOutputs" type="object" vertical>
              <BatchOutputs
                style={{ width: '100%' }}
                value={field.value}
                onChange={(val) => field.onChange(val)}
                hasError={Object.keys(fieldState?.errors || {}).length > 0}
              />
            </FormItem>
          )}
        </Field>
      </FormContent>
    </>
  );
};

export const formMeta: FormMeta = {
  render: LoopFormRender,
  effect: {
    loopFor: provideBatchInputEffect,
  },
  plugins: [createBatchOutputsFormPlugin({ outputKey: 'loopOutputs', inferTargetKey: 'outputs' })],
};
```

:::info{title="å…³äº FormHeaderã€FormContentã€FormItem"}

ä¸Šè¿°ä»£ç ä¸­çš„ `FormHeader`ã€`FormContent`ã€`FormItem` æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„å¸ƒå±€ç»„ä»¶ï¼Œç”¨äºç»Ÿä¸€è¡¨å•æ ·å¼ã€‚ä½ å¯ä»¥æ ¹æ®é¡¹ç›®éœ€æ±‚è‡ªè¡Œå®ç°æˆ–æ›¿æ¢ä¸ºå…¶ä»– UI ç»„ä»¶ã€‚

:::

## API å‚è€ƒ

### provideBatchInputEffect

æä¾›ä¸€ä¸ªè¡¨å•å‰¯ä½œç”¨ï¼Œå°†å¾ªç¯è¾“å…¥çš„æ•°ç»„å˜é‡è§£æä¸º `item` å’Œ `index` å±€éƒ¨å˜é‡ã€‚

```typescript
import { provideBatchInputEffect } from '@flowgram.ai/form-materials';

const formMeta: FormMeta = {
  effect: {
    loopFor: provideBatchInputEffect,
  },
};
```

#### å‚æ•°

è¯¥å‰¯ä½œç”¨å†…éƒ¨ä½¿ç”¨ `createEffectFromVariableProvider` åˆ›å»ºï¼Œé…ç½®å¦‚ä¸‹ï¼š

| å±æ€§ | å€¼ | è¯´æ˜ |
|------|------|------|
| `private` | `true` | ç”Ÿæˆçš„å˜é‡å­˜å‚¨åœ¨èŠ‚ç‚¹ç§æœ‰ä½œç”¨åŸŸ |

:::tip{title="å…³äº private å‚æ•°"}

è®¾ç½® `private: true` åï¼Œå˜é‡ä¼šå­˜å‚¨åœ¨ `node.privateScope` è€Œé `node.scope`ã€‚è¿™æ„å‘³ç€ï¼š
- å˜é‡ä»…åœ¨å½“å‰èŠ‚ç‚¹åŠå…¶å­èŠ‚ç‚¹ä¸­å¯è§
- ä¸ä¼šè¢«çˆ¶èŠ‚ç‚¹çš„ä¸‹æ¸¸èŠ‚ç‚¹è®¿é—®
- é€‚ç”¨äºå¾ªç¯åœºæ™¯ä¸­çš„ä¸´æ—¶è¿­ä»£å˜é‡

è¯¦è§ï¼š[èŠ‚ç‚¹ç§æœ‰ä½œç”¨åŸŸ](../../guide/variable/concept#èŠ‚ç‚¹ç§æœ‰ä½œç”¨åŸŸ)

:::

#### è¿”å›å€¼

- `EffectOptions[]`: è¡¨å•å‰¯ä½œç”¨é€‰é¡¹æ•°ç»„ï¼Œç”¨äº `formMeta.effect` é…ç½®

#### ç”Ÿæˆçš„å˜é‡ç»“æ„

å‰¯ä½œç”¨ä¼šåœ¨å½“å‰èŠ‚ç‚¹çš„**ç§æœ‰ä½œç”¨åŸŸ**ä¸‹åˆ›å»ºä¸€ä¸ªå˜é‡ `${nodeId}_locals`ï¼Œç»“æ„å¦‚ä¸‹ï¼š

| å­—æ®µ | ç±»å‹ | æè¿° |
|------|------|------|
| `item` | æ ¹æ®æ•°ç»„å…ƒç´ ç±»å‹æ¨å¯¼ | å½“å‰è¿­ä»£çš„æ•°ç»„å…ƒç´  |
| `index` | `number` | å½“å‰è¿­ä»£çš„ç´¢å¼• |

#### ç”Ÿæˆçš„ AST ç»“æ„ç¤ºä¾‹

å‡è®¾å¾ªç¯è¾“å…¥å˜é‡è·¯å¾„ä¸º `['start_0', 'list']`ï¼Œç”Ÿæˆçš„ AST ç»“æ„å¦‚ä¸‹ï¼š

```typescript
{
  kind: 'VariableDeclaration',
  key: 'loop_1_locals',
  meta: {
    title: 'å¾ªç¯èŠ‚ç‚¹',
    icon: 'loop-icon'
  },
  type: {
    kind: 'ObjectType',
    properties: [
      {
        kind: 'Property',
        key: 'item',
        initializer: {
          kind: 'EnumerateExpression',
          enumerateFor: {
            kind: 'KeyPathExpression',
            keyPath: ['start_0', 'list']
          }
        }
      },
      {
        kind: 'Property',
        key: 'index',
        type: { kind: 'NumberType' }
      }
    ]
  }
}
```

## æºç å¯¼è¯»

<SourceCode
  href="https://github.com/bytedance/flowgram.ai/tree/main/packages/materials/form-materials/src/effects/provide-batch-input/index.ts"
/>

ä½¿ç”¨ CLI å‘½ä»¤å¯ä»¥å¤åˆ¶æºä»£ç åˆ°æœ¬åœ°ï¼š

```bash
npx @flowgram.ai/cli@latest materials effects/provide-batch-input
```

### ç›®å½•ç»“æ„è®²è§£

```
provide-batch-input/
â””â”€â”€ index.ts           # ä¸»å®ç°æ–‡ä»¶ï¼Œå¯¼å‡º provideBatchInputEffect è¡¨å•å‰¯ä½œç”¨
```

### æ ¸å¿ƒå®ç°è¯´æ˜

#### å˜é‡ç”Ÿæˆé€»è¾‘

`provideBatchInputEffect` ä½¿ç”¨ [`createEffectFromVariableProvider`](../../guide/variable/variable-output) å·¥å‚å‡½æ•°åˆ›å»ºå˜é‡æä¾›å™¨ã€‚æ ¸å¿ƒç‰¹ç‚¹ï¼š

1. **ç§æœ‰å˜é‡**ï¼šè®¾ç½® `private: true`ï¼Œç”Ÿæˆçš„å˜é‡ä»…åœ¨å½“å‰èŠ‚ç‚¹ä½œç”¨åŸŸå†…å¯è§
2. **å…ƒç´ ç±»å‹æ¨å¯¼**ï¼šä½¿ç”¨ `ASTFactory.createEnumerateExpression` ä»æ•°ç»„ç±»å‹æ¨å¯¼å‡ºå…ƒç´ ç±»å‹
3. **ç´¢å¼•å˜é‡**ï¼šå›ºå®šä¸º `number` ç±»å‹

#### ç±»å‹æ¨å¯¼åŸç†

`EnumerateExpression` æ˜¯å˜é‡å¼•æ“æä¾›çš„è¡¨è¾¾å¼ç±»å‹ï¼Œç”¨äºä»æ•°ç»„ç±»å‹æ¨å¯¼å…ƒç´ ç±»å‹ï¼š

```mermaid
graph LR
    A["Array&lt;string&gt;"] --> B[EnumerateExpression]
    B --> C["string"]

    D["Array&lt;object&gt;"] --> E[EnumerateExpression]
    E --> F["object"]
```

å½“ä¸Šæ¸¸å˜é‡ç±»å‹å˜åŒ–æ—¶ï¼Œ`item` çš„ç±»å‹ä¼š**è‡ªåŠ¨è”åŠ¨æ›´æ–°**ã€‚

#### å˜é‡ç”Ÿæˆæµç¨‹æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant Form as è¡¨å•ç³»ç»Ÿ
    participant Parser as parseå‡½æ•°
    participant AST as ASTFactory
    participant Node as å½“å‰èŠ‚ç‚¹

    Form->>Parser: æä¾› IFlowRefValue å€¼
    Parser->>Node: è·å–èŠ‚ç‚¹ä¿¡æ¯
    Node-->>Parser: è¿”å›èŠ‚ç‚¹ID
    Parser->>AST: åˆ›å»ºå˜é‡å£°æ˜
    Note over Parser: é”®å: ${nodeId}_locals
    Parser->>AST: åˆ›å»º Object ç±»å‹
    Parser->>AST: åˆ›å»º item å±æ€§
    Note over AST: ä½¿ç”¨ createEnumerateExpression
    Note over AST: ä»æ•°ç»„ keyPath æ¨å¯¼å…ƒç´ ç±»å‹
    Parser->>AST: åˆ›å»º index å±æ€§
    Note over AST: å›ºå®šä¸º number ç±»å‹
    AST-->>Parser: è¿”å›åˆ›å»ºçš„å˜é‡å£°æ˜
    Parser-->>Form: è¿”å›å˜é‡å£°æ˜æ•°ç»„
```

#### å…³é”®ä»£ç è§£æ

```typescript
export const provideBatchInputEffect: EffectOptions[] = createEffectFromVariableProvider({
  private: true,
  parse: (value: IFlowRefValue, ctx) => [
    ASTFactory.createVariableDeclaration({
      key: `${ctx.node.id}_locals`,
      meta: {
        title: ctx.node.form?.getValueIn('title'),
        icon: ctx.node.getNodeRegistry<FlowNodeRegistry>().info?.icon,
      },
      type: ASTFactory.createObject({
        properties: [
          ASTFactory.createProperty({
            key: 'item',
            initializer: ASTFactory.createEnumerateExpression({
              enumerateFor: ASTFactory.createKeyPathExpression({
                keyPath: value.content || [],
              }),
            }),
          }),
          ASTFactory.createProperty({
            key: 'index',
            type: ASTFactory.createNumber(),
          }),
        ],
      }),
    }),
  ],
});
```

### ä¾èµ–æ¢³ç†

#### flowgram API

[**@flowgram.ai/editor**](https://github.com/bytedance/flowgram.ai/tree/main/packages/client/editor)
- [`EffectOptions`](https://flowgram.ai/auto-docs/editor/types/EffectOptions): è¡¨å•å‰¯ä½œç”¨é€‰é¡¹ç±»å‹
- [`FlowNodeRegistry`](https://flowgram.ai/auto-docs/document/interfaces/FlowNodeRegistry-1): èŠ‚ç‚¹æ³¨å†Œç±»å‹å®šä¹‰
- [`createEffectFromVariableProvider`](../../guide/variable/variable-output): ä»å˜é‡æä¾›å™¨åˆ›å»ºè¡¨å•å‰¯ä½œç”¨çš„å·¥å‚å‡½æ•°

[**@flowgram.ai/variable-core**](https://github.com/bytedance/flowgram.ai/tree/main/packages/variable-engine/variable-core)
- [`ASTFactory`](https://flowgram.ai/auto-docs/editor/modules/ASTFactory): AST åˆ›å»ºå·¥å‚ï¼Œç”¨äºç”Ÿæˆå˜é‡å£°æ˜
- `ASTFactory.createEnumerateExpression`: åˆ›å»ºæšä¸¾è¡¨è¾¾å¼ï¼Œç”¨äºä»æ•°ç»„ç±»å‹æ¨å¯¼å…ƒç´ ç±»å‹
- `ASTFactory.createKeyPathExpression`: åˆ›å»ºé”®è·¯å¾„è¡¨è¾¾å¼ï¼Œç”¨äºå¼•ç”¨å˜é‡è·¯å¾„

#### ä¾èµ–çš„å…¶ä»–ç‰©æ–™

[**BatchVariableSelector**](../components/batch-variable-selector)
- ç”¨äºé€‰æ‹©æ•°ç»„ç±»å‹çš„å˜é‡ï¼Œé…åˆ `provideBatchInputEffect` ä½¿ç”¨

## å¸¸è§é—®é¢˜

### ä¸ºä»€ä¹ˆ item çš„ç±»å‹èƒ½è‡ªåŠ¨æ¨å¯¼ï¼Ÿ

`provideBatchInputEffect` ä½¿ç”¨ `ASTFactory.createEnumerateExpression` åˆ›å»º `item` å˜é‡ã€‚`EnumerateExpression` æ˜¯ä¸€ç§ç‰¹æ®Šçš„è¡¨è¾¾å¼ï¼Œå®ƒä¼šï¼š

1. æ¥æ”¶ä¸€ä¸ªæ•°ç»„ç±»å‹çš„å˜é‡å¼•ç”¨ï¼ˆé€šè¿‡ `KeyPathExpression`ï¼‰
2. è‡ªåŠ¨æ¨å¯¼å‡ºæ•°ç»„çš„å…ƒç´ ç±»å‹ä½œä¸ºè‡ªå·±çš„è¿”å›ç±»å‹
3. å½“ä¸Šæ¸¸æ•°ç»„ç±»å‹å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨è§¦å‘ç±»å‹è”åŠ¨æ›´æ–°

è¯¦è§ï¼š[å˜é‡æ¦‚å¿µ - è¡¨è¾¾å¼](../../guide/variable/concept#è¡¨è¾¾å¼)

### ç”Ÿæˆçš„å˜é‡ä¸ºä»€ä¹ˆåœ¨å˜é‡é€‰æ‹©å™¨ä¸­çœ‹ä¸åˆ°ï¼Ÿ

æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š

1. **ä½œç”¨åŸŸé—®é¢˜**ï¼š`provideBatchInputEffect` ç”Ÿæˆçš„æ˜¯ç§æœ‰å˜é‡ï¼ˆå­˜å‚¨åœ¨ `node.privateScope`ï¼‰ï¼Œåªæœ‰å½“å‰èŠ‚ç‚¹åŠå…¶å­èŠ‚ç‚¹å¯ä»¥è®¿é—®
2. **é…ç½®ä½ç½®**ï¼šç¡®ä¿ `provideBatchInputEffect` é…ç½®åœ¨æ­£ç¡®çš„å­—æ®µè·¯å¾„ä¸Š
3. **ç»„ä»¶é…ç½®**ï¼šå¦‚æœä½¿ç”¨ `BatchVariableSelector`ï¼Œå®ƒä¼šè‡ªåŠ¨æä¾› `PrivateScopeProvider`ï¼›å¦‚æœä½¿ç”¨æ™®é€š `VariableSelector`ï¼Œéœ€è¦æ‰‹åŠ¨åŒ…è£¹ `PrivateScopeProvider`

### å¦‚ä½•è‡ªå®šä¹‰ item å’Œ index çš„å˜é‡åï¼Ÿ

ç›®å‰ `provideBatchInputEffect` ä¸æ”¯æŒè‡ªå®šä¹‰å˜é‡åã€‚å¦‚æœéœ€è¦è‡ªå®šä¹‰ï¼Œå¯ä»¥å‚è€ƒæºç å®ç°ï¼Œä½¿ç”¨ `createEffectFromVariableProvider` åˆ›å»ºè‡ªå·±çš„å‰¯ä½œç”¨ï¼š

```typescript
import { createEffectFromVariableProvider, ASTFactory } from '@flowgram.ai/editor';

export const customBatchInputEffect = createEffectFromVariableProvider({
  private: true,
  parse: (value, ctx) => [
    ASTFactory.createVariableDeclaration({
      key: `${ctx.node.id}_locals`,
      type: ASTFactory.createObject({
        properties: [
          ASTFactory.createProperty({
            key: 'currentItem',
            initializer: ASTFactory.createEnumerateExpression({
              enumerateFor: ASTFactory.createKeyPathExpression({
                keyPath: value.content || [],
              }),
            }),
          }),
          ASTFactory.createProperty({
            key: 'currentIndex',
            type: ASTFactory.createNumber(),
          }),
        ],
      }),
    }),
  ],
});
```

### ä¸ batchOutputsPlugin çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ

| ç‰©æ–™ | èŒè´£ | ç”Ÿæˆçš„å˜é‡ |
|------|------|------|
| `provideBatchInputEffect` | å¤„ç†å¾ªç¯**è¾“å…¥** | `item`ã€`index`ï¼ˆç§æœ‰å˜é‡ï¼‰ |
| `batchOutputsPlugin` | å¤„ç†å¾ªç¯**è¾“å‡º** | ç”¨æˆ·é…ç½®çš„è¾“å‡ºé”®ï¼ˆå…¬å…±å˜é‡ï¼Œæ•°ç»„ç±»å‹ï¼‰ |

ä¸¤è€…é…åˆä½¿ç”¨ï¼Œå½¢æˆå®Œæ•´çš„å¾ªç¯èŠ‚ç‚¹å˜é‡é€»è¾‘ï¼š

```mermaid
graph LR
    A[æ•°ç»„è¾“å…¥] --> B[provideBatchInputEffect]
    B --> C[item, index]
    C --> D[å­èŠ‚ç‚¹å¤„ç†]
    D --> E[BatchOutputs é…ç½®]
    E --> F[batchOutputsPlugin]
    F --> G[æ•°ç»„è¾“å‡º]
```

## ç›¸å…³ç‰©æ–™

- [BatchVariableSelector](../components/batch-variable-selector): æ•°ç»„å˜é‡é€‰æ‹©å™¨ï¼Œç”¨äºé€‰æ‹©å¾ªç¯è¾“å…¥
- [BatchOutputs](../components/batch-outputs): å¾ªç¯è¾“å‡ºé…ç½®ç»„ä»¶
- [batchOutputsPlugin](../form-plugins/batch-outputs-plugin): å¾ªç¯è¾“å‡ºæ’ä»¶ï¼Œå¤„ç†ä½œç”¨åŸŸé“¾å’Œç±»å‹æ¨å¯¼
